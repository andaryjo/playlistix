<html>

<head>
    <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</head>

<body>

    <main class="container">
        <div x-data="data()" x-init="start()">

            <nav>
                <ul>
                    <li><strong>playlistex for Spotify</strong></li>
                </ul>
                <ul>
                    <li x-show="userName"><kbd x-text="userName"></kbd></a></li>
                </ul>
            </nav>
            <br>

            This site allows you to export and import Spotify playlists. It runs only in your browser, does not share your user data and is open source.
            <br>

            <article>
                <div x-show="!loggedIn">
                    <button @click="redirectLogin()">Sign In to view your playlists</button>
                </div>
                <div x-show="loggedIn && playlists == null" aria-busy="true">Loading playlists...</div>
                <div x-show="loggedIn && playlists != null">
                    <template x-for="(playlist, index) in playlists">
                        <nav>
                            <ul>
                                <li><img x-bind:src="playlist.images[0].url" width="100" height="100"></img></li>
                                <li>
                                    <p x-text="playlist.name"></p>
                                </li>
                            </ul>
                            <ul>
                                <li><button @click="exportPlaylist(index)">Export</button></li>
                            </ul>
                        </nav>
                        <div>


                        </div>
                    </template>
                </div>
            </article>

        </div>
    </main>

    <script>

        const data = () => {
            return {
                loggedIn: false,
                authCode: null,
                authCodeVerifier: null,
                accessToken: null,
                userName: null,
                playlists: null,
                start: async function () {
                    this.accessToken = localStorage.getItem('accessToken');
                    if (!this.accessToken) {
                        // Read auth code verifier from local storage. Create new one if it does not exist yet
                        this.authCodeVerifier = localStorage.getItem('authCodeVerifier');
                        if (!this.authCodeVerifier) {
                            this.authCodeVerifier = generateCodeVerfier();
                            localStorage.setItem('authCodeVerifier', this.authCodeVerifier);
                        }

                        // Read auth code from callback and write it to local storage
                        // If there was no callback, try to read it from local storage
                        // User is not logged In of the auth code is neither in storage nor in callback
                        let codeFromCallback = getParameterByName('code');
                        if (codeFromCallback) {
                            this.authCode = codeFromCallback;
                            localStorage.setItem('authCode', this.authCode);
                        } else {
                            this.authCode = localStorage.getItem('authCode');
                        }
                        if (this.authCode == null) return;

                        // Fetch access token if auth code is present
                        this.accessToken = await this.fetchAccessToken();
                        localStorage.setItem('accessToken', this.accessToken);
                    }

                    this.loggedIn = true;
                    window.history.replaceState('', '', '/');
                    this.fetchUserName();
                    this.fetchPlaylists();
                },
                exportPlaylist: async function (index) {
                    console.log(this.playlists[index].id);
                },
                fetchUserName: async function () {
                    axios.get('https://api.spotify.com/v1/me', { headers: { 'Authorization': 'Bearer ' + this.accessToken } }).then(res => {
                        this.userName = res.data.display_name;
                    }).catch(err => {
                        console.log(err);
                        if (err.response.status == 401) this.fetchAccessToken();
                    });
                },
                fetchPlaylists: async function () {
                    axios.get('https://api.spotify.com/v1/me/playlists', { headers: { 'Authorization': 'Bearer ' + this.accessToken } }).then(res => {
                        this.playlists = res.data.items;
                    }).catch(err => {
                        console.log(err);
                        if (err.response.status == 401) this.fetchAccessToken();
                    });
                },
                fetchPlaylistById: async function (id) {
                    axios.get('https://api.spotify.com/v1/me/playlists/' + id, { headers: { 'Authorization': 'Bearer ' + this.accessToken } }).then(res => {
                        this.playlists = res.data.items;
                    }).catch(err => {
                        console.log(err);
                        if (err.response.status == 401) this.fetchAccessToken();
                    });
                },
                redirectLogin: async function () {
                    window.location.href = 'https://accounts.spotify.com/authorize?' + urlEncodeObject({
                        response_type: 'code',
                        client_id: '330b334d020847a3bf0ff98ab27168f4',
                        scope: 'playlist-read-private,playlist-read-collaborative',
                        show_dialog: 'false',
                        redirect_uri: 'http://localhost:8080',
                        code_challenge_method: 'S256',
                        code_challenge: await getPkceChallengeFromVerifier(this.authCodeVerifier)
                    });
                },
                fetchAccessToken: async function () {
                    localStorage.setItem('accessToken', null);
                    return new Promise((resolve) => {
                        axios.post('https://accounts.spotify.com/api/token', urlEncodeObject({
                            grant_type: 'authorization_code',
                            client_id: '330b334d020847a3bf0ff98ab27168f4',
                            code: this.authCode,
                            redirect_uri: 'http://localhost:8080',
                            code_verifier: this.authCodeVerifier
                        })).then(res => {
                            resolve(res.data.access_token);
                        }).catch(err => {
                            console.log(err);
                        })
                    });
                }
            }
        }

        // https://stackoverflow.com/a/901144
        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'), results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        // https://stackoverflow.com/a/1714899/17793205
        function urlEncodeObject(obj) {
            var str = [];
            for (var p in obj)
                if (obj.hasOwnProperty(p)) {
                    str.push(encodeURIComponent(p) + '=' + encodeURIComponent(obj[p]));
                }
            return str.join('&');
        }

        function generateCodeVerfier() {
            var verifier = '';
            var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            var charactersLength = characters.length;
            for (var i = 0; i < 128; i++) {
                verifier += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return verifier;
        }

        // https://stackoverflow.com/a/59913241/17793205
        function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function getPkceChallengeFromVerifier(verifier) {
            hashed = await sha256(verifier);
            base64encoded = base64urlencode(hashed);
            return base64encoded;
        }

    </script>

</body>

</html>